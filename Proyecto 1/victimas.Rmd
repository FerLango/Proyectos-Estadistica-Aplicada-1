---
title: "Víctimas en carpetas de investigación FGJ"
subtitle: "Estadística Aplicada 1 - Proyecto 1"
author: "Fernando Lango - 181055"
email: "flangoba@itam.mx"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
name: "Proyecto 1"
toc-title: Contenido  
indent: True
#bibliography: citations.bib
#csl: apa.csl 
#nocite: '@*'
#link-citations: True
output: 
  prettydoc::html_pretty:
    theme: cayman
    toc: True
    highlight: github
    number_sections: True
    fig_caption: True
    pandoc_args: [ "--output=index.html"]
    #includes:
      #in_header: "Icono/icono.html"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      message = FALSE, fig.align = "center",
                      cache = FALSE)
```

# Introducción

Insertar intro de lo que se va a hacer.

## Ambiente de R

Para el análisis de los datos se utilizaron las librerías que se muestran a continuación:

- `plotly` -> animación de gráficas.
- `tidyverse` -> carga de archivos csv, creación de gráficas y manipulación de tablas.
- `lubridate` -> manejo de fechas.
- `openxlsx` -> carga de archivos de excel.
- `kableExtra` -> diseño de tablas.
- `sf` -> leer archivos shp para el mapa.
- `moments` -> asimetría y curtosis.

```{r lib}
library(plotly)
library(tidyverse)
library(lubridate)
library(openxlsx)
library(kableExtra)
library(sf)
library(moments)
library(gganimate)
library(wordcloud2)
```

## Conjunto de datos

Los conjuntos de datos utilizados en el presente análisis se pueden descargar en [Víctimas en carpetas de investigación](https://archivo.datos.cdmx.gob.mx/fiscalia-general-de-justicia/victimas-en-carpetas-de-investigacion-fgj/victimas_completa_julio_2021.csv) y [Diccionario de víctimas](https://datos.cdmx.gob.mx/dataset/7593b324-6010-44f7-8132-cb8b2276c842/resource/10235569-f4a9-4876-9465-9780887df8e2/download/diccionario-de-victimas-actualizado.xlsx) dentro del [Portal de Datos Abiertos de la CDMX](https://datos.cdmx.gob.mx/). Para mayor información del conjunto de datos se puede consultar en [Víctimas en carpetas de investigación FGJ](https://datos.cdmx.gob.mx/dataset/victimas-en-carpetas-de-investigacion-fgj).

La base contiene la información de las víctimas de diversos delitos que cuentan con una carpeta de investigación en la [Fiscalía General de Justicia (FGJ) de la Ciudad de México](https://www.fgjcdmx.gob.mx/) a partir de enero del año 2019.

### Descarga

```{r data, cache=TRUE}
data_url <- "https://archivo.datos.cdmx.gob.mx/fiscalia-general-de-justicia/victimas-en-carpetas-de-investigacion-fgj/victimas_completa_julio_2021.csv"

victimas <- read_csv(data_url, show_col_types = FALSE)

dicc_url <- "https://datos.cdmx.gob.mx/dataset/7593b324-6010-44f7-8132-cb8b2276c842/resource/10235569-f4a9-4876-9465-9780887df8e2/download/diccionario-de-victimas-actualizado.xlsx"

diccionario <- read.xlsx(dicc_url, sheet =1)
```

### Formato de columnas

```{r format}
victimas$Mes_inicio <- as.factor(victimas$Mes_inicio)
victimas$FechaInicio <- dmy(victimas$FechaInicio)
victimas$Delito <- as.factor(victimas$Delito)
victimas$Categoria <- as.factor(victimas$Categoria)
victimas$Sexo <- as.factor(victimas$Sexo)
victimas$TipoPersona <- as.factor(victimas$TipoPersona)
victimas$CalidadJuridica <- as.factor(victimas$CalidadJuridica)
victimas$competencia <- as.factor(victimas$competencia)
victimas$Mes_hecho <- as.factor(victimas$Mes_hecho)
victimas$FechaHecho <- dmy(victimas$FechaHecho)
victimas$AlcaldiaHechos <- as.factor(victimas$AlcaldiaHechos)
```

### Descripción de las variables

```{r variables}
diccionario[,1:2] %>%
  kable()
```

# Análisis exploratorio

## Estadísticos

```{r estad}
victimas %>%
  select(Año_inicio, Sexo, Edad) %>%
  rename('Año inicio'=Año_inicio) %>%
  filter(!is.na(Edad), !is.na(Sexo), Edad>0, Edad<150) %>%
  group_by(`Año inicio`, Sexo) %>%
  summarise(Media = round(mean(Edad),2),
            SD = round(sd(Edad),2),
            Mediana = median(Edad),
            Asimetría = round(skewness(Edad),2),
            Curtosis = round(kurtosis(Edad),2),
            IQR = IQR(Edad),
            Mínimo = min(Edad),
            Máximo = max(Edad)) %>%
  kable()
```


## Gráficas

### Mapa

```{r map, cache=TRUE}
if (!dir.exists("datos_mapa")) {
  map_url <- "https://github.com/prestevez/covid-19-mx-map/raw/master/datos_covid/01_32_mun.zip"
  download.file(map_url, destfile = "datos_mapa.zip")
  unzip("datos_mapa.zip", exdir = "datos_mapa")
  file.remove("datos_mapa.zip")
}

mex_map <- 
  st_read("datos_mapa/01_32_mun.shp", quiet = TRUE) %>% 
  st_set_crs("+proj=lcc +lat_1=17.5 +lat_2=29.5 +lat_0=12 +lon_0=-102 +x_0=2500000 +y_0=0 +ellps=GRS80 +units=m +no_defs") %>%
  filter(CVE_ENT == "09") %>%
  rename(Alcaldia = NOMGEO)


mex_map$Alcaldia <- chartr("ÁÉÍÓÚ", "AEIOU", 
                         toupper(mex_map$Alcaldia))

map_filt <- 
  victimas %>% 
  select(AlcaldiaHechos) %>%
  group_by(AlcaldiaHechos) %>%
  tally(name = "Delitos") %>%
  na.omit()

map_filt$AlcaldiaHechos <- 
  str_replace(map_filt$AlcaldiaHechos,
              "GUSTAVO A MADERO", "GUSTAVO A. MADERO")


mex_map_del <- 
  left_join(mex_map, map_filt, 
            by = c("Alcaldia" = "AlcaldiaHechos"))

rm(mex_map)
rm(map_filt)

map <- 
  ggplot() +
  geom_sf(data = mex_map_del, 
          aes(fill = Delitos, shape = Alcaldia),
          colour = "grey75", size = 0.1) +
  labs(title = "Cantidad de delitos por alcaldía") +
  theme_bw() + 
  scale_fill_gradient("Total de delitos", 
                      high = "red", low = "yellow") +
  theme(legend.position = "none")

ggplotly(map, tooltip = c("Delitos","Alcaldia"))

```

### Boxplot

```{r box}
box <- 
  victimas %>%
  filter(Edad<150) %>%
  ggplot() + 
  geom_boxplot(aes(x = factor(Año_inicio),y = Edad, 
                   color = factor(Año_inicio)))

ggplotly(box)

```

### Histograma

```{r histo}
histo <- 
  victimas %>%
  filter(!is.na(Sexo), !is.na(CalidadJuridica)) %>%
  ggplot() +
  geom_histogram(aes(CalidadJuridica, fill = Sexo), 
                 stat = "count") +
  facet_grid(Año_inicio~.) +
  coord_flip()

ggplotly(histo)
```

### Gráfica de barras

```{r bar}
bar <-
  victimas %>%
  mutate(inicio_vs_hecho = difftime(FechaInicio, FechaHecho,
                                   units = "days")) %>%
  group_by(Categoria) %>%
  summarise(inicio_vs_hecho = mean(inicio_vs_hecho, 
                                   na.rm = TRUE)) %>%
  arrange(Categoria) %>%
  ggplot() +
  geom_bar(aes(x=Categoria, y=inicio_vs_hecho, fill = Categoria),
           stat = "identity") +
  coord_flip() +
  theme(legend.position = "none")+
  scale_x_discrete(labels=
                     substr(unique(sort(victimas$Categoria)),0,20))
ggplotly(bar)
  
```

### Scatter

```{r scatter}
scat <-
  victimas %>%
  mutate(inicio_vs_hecho = difftime(FechaInicio, FechaHecho,
                                   units = "days")) %>%
  filter(Edad<150, Edad>0, Categoria == "VIOLACIÓN",
         !is.na(Sexo)) %>%
  ggplot() +
  geom_point(aes(x=Edad, y=inicio_vs_hecho, color = Sexo)) +
  labs(subtitle = 'Fecha: {frame_time}') +
  ylim(0,5000) + 
  transition_time(FechaInicio) +
  ease_aes('linear')

animate(scat, duration = 40)
```

### Heatmap

```{r heat}
heat <- 
  victimas %>%
  select(Mes_hecho, Categoria) %>%
  filter(!is.na(Mes_hecho), Categoria != "DELITO DE BAJO IMPACTO") %>%
  group_by(Mes_hecho, Categoria) %>%
  tally() %>%
  arrange(Categoria) %>% 
  ggplot(aes(x=factor(Mes_hecho, 
                      levels = c("Enero","Febrero","Marzo",
                                 "Abril","Mayo","Junio",
                                 "Julio","Agosto","Septiembre",
                                 "Octubre","Noviembre",
                                 "Diciembre")), 
             y=Categoria, fill=n)) +
  geom_tile() +
  theme(legend.position = "none") +
  scale_y_discrete(labels=
                     substr(unique(sort(victimas$Categoria)),0,20)) + 
  scale_fill_gradient(low = "yellow", high = "red")

ggplotly(heat)
```

### Densidad

```{r dens}
dens <- 
  victimas %>%
  select(Edad) %>%
  filter(Edad < 150, Edad>0) %>%
  ggplot(aes(x=Edad)) +
  geom_density(fill="#69b3a2", color="darkgreen", alpha=0.8, size=1)

ggplotly(dens)
```
### Pie

```{r pie}
pie1 <- 
  victimas %>%
  select(CalidadJuridica) %>%
  group_by(CalidadJuridica) %>%
  tally() %>%
  na.omit() %>%
  plot_ly(labels = ~CalidadJuridica, values = ~n, type = 'pie')

pie1

pie2 <- 
  victimas %>%
  select(competencia) %>%
  group_by(competencia) %>%
  tally() %>%
  na.omit() %>%
  plot_ly(labels = ~competencia, values = ~n, type = 'pie')

pie2

pie3 <- 
  victimas %>%
  select(TipoPersona) %>%
  group_by(TipoPersona) %>%
  tally() %>%
  na.omit() %>%
  plot_ly(labels = ~TipoPersona, values = ~n, type = 'pie')

pie3

pie4 <- 
  victimas %>%
  select(Sexo) %>%
  group_by(Sexo) %>%
  tally() %>%
  na.omit() %>%
  plot_ly(labels = ~Sexo, values = ~n, type = 'pie')

pie4
```

### Wordcloud

```{r cloud}
cloud <- 
  victimas %>%
  select(Delito) %>%
  group_by(Delito) %>%
  tally() %>%
  na.omit() %>%
  wordcloud2(size=2, color='random-dark',
             backgroundColor="white", shape = "circle")

cloud
```


### Lollipop

```{r lolli}
loli <- 
  data.frame(dia = as.character(wday(victimas$FechaHecho, 
                               label = TRUE, abbr = FALSE))) %>%
  group_by(dia) %>%
  tally() %>%
  na.omit() %>%
  ggplot(aes(x=dia, y=n)) +
  geom_segment(aes(xend=dia, yend=0)) +
  geom_point(size=4, color= "#189c54") +
  theme_bw()

ggplotly(loli)
```


# Referencias


























